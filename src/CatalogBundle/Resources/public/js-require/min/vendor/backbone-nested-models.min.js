!function(t,e){"object"==typeof exports?module.exports=e(require("backbone"),require("underscore")):"function"==typeof define&&define.amd?define(["backbone","underscore"],function(i,n){return t.returnExportsGlobal=e(i,n)}):t.returnExportsGlobal=e(t.Backbone,t._)}(this,function(t,e){var i=t.Model,n=t.Collection;return t.Model.prototype.setRelation=function(t,s,r){var o=this.attributes[t];if(this.idAttribute||"id",r.unset&&o&&delete o.parent,this.relations&&e.has(this.relations,t)){if(o&&o instanceof n)return s=s instanceof n||s instanceof Array?s.models||s:[s],o.set(s,r),o;if(o&&o instanceof i)return s instanceof i&&(s=s.toJSON()),o.set(s,r),o;r._parent=this,s instanceof n||(s=new this.relations[t](s,r)),s.parent=this}return s},t.Model.prototype.set=function(t,i,n){var s,r,o,h,a,u,l,c;if(null==t)return this;if("object"==typeof t?(r=t,n=i):(r={})[t]=i,n||(n={}),!this._validate(r,n))return!1;o=n.unset,a=n.silent,h=[],u=this._changing,this._changing=!0,u||(this._previousAttributes=e.clone(this.attributes),this.changed={}),c=this.attributes,l=this._previousAttributes,this.idAttribute in r&&(this.id=r[this.idAttribute]);for(s in r)i=r[s],i=this.setRelation(s,i,n),e.isEqual(c[s],i)||h.push(s),e.isEqual(l[s],i)?delete this.changed[s]:this.changed[s]=i,o?delete c[s]:c[s]=i;if(!a){h.length&&(this._pending=!0);for(var f=0,d=h.length;d>f;f++)this.trigger("change:"+h[f],this,c[h[f]],n)}if(u)return this;if(!a)for(;this._pending;)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},t.Model.prototype.toJSON=function(t){var i=e.clone(this.attributes);return e.each(this.relations,function(t,n){e.has(i,n)?i[n]=i[n].toJSON():i[n]=(new t).toJSON()}),i},t.Model.prototype.clone=function(t){return new this.constructor(this.toJSON())},t.Collection.prototype.resetRelations=function(i){e.each(this.models,function(n){e.each(n.relations,function(e,s){n.get(s)instanceof t.Collection&&n.get(s).trigger("reset",n,i)})})},t.Collection.prototype.reset=function(t,i){i||(i={});for(var n=0,s=this.models.length;s>n;n++)this._removeReference(this.models[n]);return i.previousModels=this.models,this._reset(),this.add(t,e.extend({silent:!0},i)),i.silent||(this.trigger("reset",this,i),this.resetRelations(i)),this},t});